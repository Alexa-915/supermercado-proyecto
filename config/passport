// config/passport.js - VERSI√ìN ULTRA SEGURA üîí
const passport = require('passport');
const GoogleStrategy = require('passport-google-oauth20').Strategy;
const Cliente = require('../models/Cliente');

// ‚úÖ Validar variables de entorno
if (!process.env.GOOGLE_CLIENT_ID || !process.env.GOOGLE_CLIENT_SECRET) {
  console.error('‚ùå ERROR: Faltan las credenciales de Google OAuth en .env');
  throw new Error('Faltan las credenciales de Google OAuth en .env');
}

console.log('üîê Google OAuth configurado en modo SEGURO');
console.log('üìç Callback URL:', process.env.GOOGLE_CALLBACK_URL);

// ========================================
// ESTRATEGIA DE GOOGLE - SOLO AUTENTICAR
// NO CREAR USUARIOS NUEVOS
// ========================================
passport.use(new GoogleStrategy({
  clientID: process.env.GOOGLE_CLIENT_ID,
  clientSecret: process.env.GOOGLE_CLIENT_SECRET,
  callbackURL: process.env.GOOGLE_CALLBACK_URL || 'http://localhost:3001/auth/google/callback',
  scope: ['profile', 'email'],
  proxy: true,
  passReqToCallback: false
}, 
async (accessToken, refreshToken, profile, done) => {
  try {
    const email = profile.emails[0].value;
    const nombre = profile.name?.givenName || 'Usuario';
    
    console.log('\nüîç ===== INTENTO DE LOGIN CON GOOGLE =====');
    console.log('üìß Email:', email);
    console.log('üë§ Nombre:', nombre);
    console.log('‚è∞ Fecha:', new Date().toLocaleString());
    
    // üîí BUSCAR USUARIO EN LA BASE DE DATOS
    const cliente = await Cliente.findOne({ where: { correo: email } });
    
    // ‚ùå SI NO EXISTE, RECHAZAR INMEDIATAMENTE
    if (!cliente) {
      console.log('‚ùå ACCESO DENEGADO: Usuario no registrado');
      console.log('üö´ Email rechazado:', email);
      console.log('=========================================\n');
      
      // ‚ö†Ô∏è IMPORTANTE: Retornar false para RECHAZAR el login
      return done(null, false, { 
        message: 'Esta cuenta de Google no est√° registrada. Debes registrarte primero.' 
      });
    }
    
    // ‚úÖ SI EXISTE, VERIFICAR QUE LA CONTRASE√ëA SEA 'GOOGLE_AUTH'
    // (Esto asegura que fue registrado correctamente con Google)
    if (cliente.contrasena !== 'GOOGLE_AUTH') {
      console.log('‚ö†Ô∏è ADVERTENCIA: Usuario existe pero no fue registrado con Google');
      console.log('üìß Email:', email);
      // A√∫n as√≠, permitir el acceso (es un usuario leg√≠timo)
    }
    
    console.log('‚úÖ ACCESO PERMITIDO: Cliente encontrado');
    console.log('üÜî ID del cliente:', cliente.id);
    console.log('üìß Email verificado:', cliente.correo);
    console.log('=========================================\n');
    
    // ‚úÖ Retornar el usuario encontrado
    return done(null, cliente);
    
  } catch (err) {
    console.error('\n‚ùå ===== ERROR EN AUTENTICACI√ìN =====');
    console.error('Error:', err.message);
    console.error('Stack:', err.stack);
    console.error('=====================================\n');
    return done(err, null);
  }
}));

// ========================================
// SERIALIZACI√ìN - Guardar ID en sesi√≥n
// ========================================
passport.serializeUser((user, done) => {
  console.log('üíæ Serializando usuario ID:', user.id, '- Email:', user.correo);
  done(null, user.id);
});

// ========================================
// DESERIALIZACI√ìN - Recuperar usuario completo
// ========================================
passport.deserializeUser(async (id, done) => {
  try {
    const cliente = await Cliente.findByPk(id);
    
    if (!cliente) {
      console.log('‚ö†Ô∏è Usuario no encontrado al deserializar ID:', id);
      return done(null, false);
    }
    
    console.log('üì¶ Deserializando usuario:', cliente.correo);
    done(null, cliente);
  } catch (err) {
    console.error('‚ùå Error al deserializar:', err);
    done(err, null);
  }
});

module.exports = passport;